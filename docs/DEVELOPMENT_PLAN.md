# Plan de Desarrollo - Sistema de Comunicaci√≥n y Autorizaci√≥n Multi-capa

**Fecha de An√°lisis:** 2025-01-04  
**Estado del Proyecto:** Refactorizaci√≥n Completa (Commit df77c92)  
**Objetivo:** Implementar sistema de eventos y autorizaci√≥n multi-capa siguiendo AWS IAM + Organizations

---

## üìä Estado Actual del Proyecto

### ‚úÖ Componentes Ya Implementados

#### 1. Infraestructura Base
- ‚úÖ **Workspace Multi-Crate**: Estructura modular con bounded contexts
- ‚úÖ **Arquitectura VSA**: Vertical Slice Architecture por feature
- ‚úÖ **Clean Architecture**: Separaci√≥n domain/application/infrastructure
- ‚úÖ **Unit of Work Pattern**: Implementado en `shared/src/application/ports/unit_of_work.rs`

#### 2. Bounded Context: hodei-authorizer
- ‚úÖ **EvaluatePermissionsUseCase**: Caso de uso principal implementado
- ‚úÖ **Integraci√≥n IAM**: Usa `GetEffectivePoliciesForPrincipalUseCase` de hodei-iam
- ‚úÖ **Integraci√≥n SCPs**: Usa `GetEffectiveScpsUseCase` v√≠a trait `GetEffectiveScpsPort`
- ‚úÖ **L√≥gica Multi-capa**: Eval√∫a SCPs antes que IAM policies
- ‚ö†Ô∏è **Providers Legacy**: Existen `IamPolicyProvider` y `OrganizationBoundaryProvider` (deprecated)
- ‚úÖ **DI Container**: Implementado con builder pattern
- ‚úÖ **Aspectos Transversales**: Traits para Cache, Logger, Metrics

#### 3. Bounded Context: hodei-iam
- ‚úÖ **GetEffectivePoliciesForPrincipalUseCase**: Implementado
- ‚úÖ **Domain Model**: User, Group, Policy entities
- ‚úÖ **SurrealIamPolicyProvider**: Implementaci√≥n para hodei-authorizer (legacy)
- ‚úÖ **Repositorios**: User, Group, Policy repositories

#### 4. Bounded Context: hodei-organizations
- ‚úÖ **Features Implementadas**:
  - `attach_scp`: Con puertos segregados ‚úÖ
  - `create_account`: Estructura VSA completa
  - `create_ou`: Estructura VSA completa
  - `create_scp`: Estructura VSA completa
  - `get_effective_scps`: Retorna PolicySet de Cedar
  - `move_account`: Con UnitOfWork para atomicidad ‚úÖ
- ‚úÖ **Domain Model**: Account, OrganizationalUnit, ServiceControlPolicy
- ‚úÖ **Puertos Segregados**: Implementados en attach_scp

#### 5. Bounded Context: policies
- ‚úÖ **Features Implementadas**:
  - `policy_analysis`: An√°lisis est√°tico de pol√≠ticas ‚úÖ
  - `create_policy`, `update_policy`, `delete_policy`
  - `get_policy`, `list_policies`
  - `validate_policy`
  - `policy_playground`: Simulaci√≥n de evaluaci√≥n
  - `batch_eval`: Evaluaci√≥n en lote
- ‚úÖ **AuthorizationEngine**: Motor de evaluaci√≥n Cedar

#### 6. Sistema de Eventos (Parcial)
- ‚ö†Ô∏è **Estructuras B√°sicas**: `DomainEvent`, `Event`, `EventStream` en `shared/src/events.rs`
- ‚ùå **EventBus Traits**: NO implementados
- ‚ùå **InMemoryEventBus**: NO implementado
- ‚ùå **EventPublisher/Subscriber**: NO implementados
- ‚ùå **Event Handlers**: NO implementados

---

## üéØ An√°lisis por Epic

### Epic 0: Infraestructura de Eventos de Dominio

**Estado:** 10% Completado

| HU | Historia | Estado | Prioridad | Estimaci√≥n |
|----|----------|--------|-----------|------------|
| HU-0.1 | Definir abstracciones del bus de eventos | ‚ö†Ô∏è Parcial | üî¥ CR√çTICA | 4h |
| HU-0.2 | Implementar InMemoryEventBus con broadcast | ‚ùå Pendiente | üî¥ CR√çTICA | 8h |
| HU-0.3 | Implementar adaptador NATS | ‚ùå Pendiente | üü° Media | 16h |
| HU-0.4 | Configurar DI global del bus | ‚ùå Pendiente | üî¥ CR√çTICA | 4h |

**An√°lisis:**
- Existe `shared/src/events.rs` con estructuras b√°sicas pero sin traits de bus
- El enum `DomainEvent` est√° vac√≠o (comentado)
- No hay implementaci√≥n de publisher/subscriber
- **Decisi√≥n:** Este Epic es PREREQUISITO para Epic 6 (hodei-configurations)

**Recomendaci√≥n:** Implementar HU-0.1 y HU-0.2 primero (sprint 1)

---

### Epic 1: Refactorizaci√≥n y Alineamiento Arquitect√≥nico

**Estado:** 60% Completado

| HU | Historia | Estado | Notas |
|----|----------|--------|-------|
| HU-1.1 | Definir puertos segregados attach_scp | ‚úÖ HECHO | `attach_scp/ports.rs` completo |
| HU-1.2 | Implementar adaptadores attach_scp | ‚úÖ HECHO | `attach_scp/adapter.rs` completo |
| HU-1.3 | Refactorizar AttachScpUseCase | ‚úÖ HECHO | Tests pasando 100% |
| HU-1.4 | Garantizar atomicidad con UnitOfWork | ‚úÖ HECHO | Implementado en move_account |
| HU-1.5 | Account con SCPs directas | ‚úÖ HECHO | Campo `attached_scps` existe |
| HU-1.6 | Centralizar generaci√≥n de HRN | ‚ö†Ô∏è Revisar | Verificar create_account |

**An√°lisis:**
- La mayor√≠a de refactorizaciones est√°n completas
- HU-1.6 requiere verificaci√≥n: revisar si `CreateAccountCommand` tiene campo `hrn`

**Recomendaci√≥n:** Validar HU-1.6 y cerrar Epic 1

---

### Epic 2: Motor de Autorizaci√≥n Central

**Estado:** 80% Completado

| HU | Historia | Estado | Notas |
|----|----------|--------|-------|
| HU-2.1 | Andamiaje hodei-authorizer | ‚úÖ HECHO | Estructura VSA completa |
| HU-2.2 | Implementar IamPolicyProvider | ‚úÖ HECHO | `SurrealIamPolicyProvider` existe |
| HU-2.3 | L√≥gica de decisi√≥n IAM | ‚úÖ HECHO | `EvaluatePermissionsUseCase` funcional |

**An√°lisis:**
- El motor est√° operacional y evaluando pol√≠ticas IAM
- Usa `GetEffectivePoliciesForPrincipalUseCase` correctamente
- Los tests pasan (11/11)
- **IMPORTANTE:** Existe c√≥digo legacy (`IamPolicyProvider` trait) que debe eliminarse

**Recomendaci√≥n:** Epic cerrado funcionalmente, limpiar c√≥digo legacy

---

### Epic 3: Integrar L√≠mites Organizacionales (SCPs)

**Estado:** 90% Completado

| HU | Historia | Estado | Notas |
|----|----------|--------|-------|
| HU-3.1 | Implementar OrganizationBoundaryProvider | ‚ö†Ô∏è Legacy | Existe pero deprecated |
| HU-3.2 | Integrar evaluaci√≥n de SCPs | ‚úÖ HECHO | Eval√∫a SCPs antes que IAM |

**An√°lisis:**
- La integraci√≥n funcional est√° completa
- `EvaluatePermissionsUseCase` eval√∫a SCPs correctamente usando `GetEffectiveScpsUseCase`
- Existe `OrganizationBoundaryProvider` legacy que debe eliminarse
- La l√≥gica de prioridad (SCP Deny > IAM) est√° implementada

**Recomendaci√≥n:** Epic cerrado funcionalmente, limpiar c√≥digo legacy

---

### Epic 4: An√°lisis Proactivo de Pol√≠ticas

**Estado:** 90% Completado

| HU | Historia | Estado | Notas |
|----|----------|--------|-------|
| HU-4.1 | Crear endpoint /policies/analyze | ‚ùå Pendiente | Feature existe, falta REST API |
| HU-4.2 | Implementar reglas adicionales | ‚ö†Ô∏è Revisar | Ver qu√© reglas existen |

**An√°lisis:**
- El crate `policies` tiene feature `policy_analysis` completamente implementada
- Falta exponer v√≠a REST API en `src/api_http`
- La l√≥gica de negocio est√° lista para consumirse

**Recomendaci√≥n:** Implementar HU-4.1 (sprint 2) - baja complejidad

---

### Epic 5: Auditor√≠a y Trazabilidad

**Estado:** 0% Completado

| HU | Historia | Estado | Prioridad | Estimaci√≥n |
|----|----------|--------|-----------|------------|
| HU-5.1 | Integrar AuditLogger en EvaluatePermissions | ‚ùå Pendiente | üü† Alta | 8h |
| HU-5.2 | Implementar SurrealAuditLogger | ‚ùå Pendiente | üü† Alta | 12h |

**An√°lisis:**
- No existe ning√∫n trait `AuditLogger` en el c√≥digo actual
- No hay sistema de auditor√≠a implementado
- `EvaluatePermissionsUseCase` no registra decisiones
- Necesita:
  1. Definir trait `AuditLogger` en shared
  2. Definir modelo `AuditEvent`
  3. Implementar `SurrealAuditLogger`
  4. Inyectar en `EvaluatePermissionsUseCase`

**Recomendaci√≥n:** Implementar en sprint 2-3 (despu√©s de Epic 0)

---

### Epic 6: Servicio de Auditor√≠a de Configuraci√≥n

**Estado:** 0% Completado

| HU | Historia | Estado | Prioridad | Estimaci√≥n |
|----|----------|--------|-----------|------------|
| HU-6.1 | Instrumentar publicaci√≥n de eventos | ‚ùå Pendiente | üî¥ CR√çTICA | 16h |
| HU-6.2 | Implementar registro de cambios | ‚ùå Pendiente | üî¥ CR√çTICA | 20h |
| HU-6.3 | Motor de evaluaci√≥n de cumplimiento | ‚ùå Pendiente | üü† Alta | 24h |
| HU-6.4 | APIs de cumplimiento | ‚ùå Pendiente | üü° Media | 16h |

**An√°lisis:**
- No existe el crate `hodei-configurations`
- **DEPENDE COMPLETAMENTE de Epic 0** (infraestructura de eventos)
- Requiere un bounded context nuevo completo
- Es el epic m√°s grande y complejo

**Recomendaci√≥n:** Posponer hasta completar Epic 0 (sprint 4+)

---

## üìÖ Plan de Implementaci√≥n Propuesto

### Sprint 1: Fundamentos de Eventos (2 semanas)

**Objetivo:** Establecer infraestructura de comunicaci√≥n as√≠ncrona

#### Semana 1
- [ ] **HU-0.1**: Definir traits del bus de eventos (4h)
  - Crear `shared/src/application/ports/event_bus.rs`
  - Traits: `EventPublisher`, `EventSubscriber`, `EventHandler`
  - Actualizar `DomainEvent` enum
  
- [ ] **HU-0.2**: Implementar InMemoryEventBus (8h)
  - Crear `shared/src/infrastructure/in_memory_event_bus.rs`
  - Usar `tokio::sync::broadcast::channel`
  - Tests unitarios completos

#### Semana 2
- [ ] **HU-0.4**: Configurar DI global (4h)
  - Modificar `src/api_http/src/di_config.rs`
  - Registrar bus como singleton
  - Conectar subscribers

- [ ] **HU-1.6**: Validar centralizaci√≥n de HRN (2h)
  - Revisar `CreateAccountCommand`
  - Corregir si es necesario

- [ ] **Limpieza Legacy**: Eliminar providers deprecated (4h)
  - Eliminar `IamPolicyProvider` trait en hodei-authorizer/ports
  - Eliminar `OrganizationBoundaryProvider` trait
  - Eliminar archivos legacy en hodei-iam

**Entregables:**
- ‚úÖ Sistema de eventos funcional in-memory
- ‚úÖ Tests: 100% cobertura del bus de eventos
- ‚úÖ Documentaci√≥n: Gu√≠a de uso del bus de eventos

---

### Sprint 2: Auditor√≠a y API de An√°lisis (2 semanas)

**Objetivo:** A√±adir trazabilidad y exponer an√°lisis de pol√≠ticas

#### Semana 1
- [ ] **HU-5.1**: Crear sistema de auditor√≠a (8h)
  - Definir trait `AuditLogger` en shared
  - Definir modelo `AuditEvent`
  - Integrar en `EvaluatePermissionsUseCase`

- [ ] **HU-5.2**: Implementar persistencia (12h)
  - Crear `SurrealAuditLogger`
  - Schema de tabla `audit_log`
  - Tests de integraci√≥n

#### Semana 2
- [ ] **HU-4.1**: Endpoint de an√°lisis de pol√≠ticas (6h)
  - Crear `src/api_http/src/api/policies/handlers.rs`
  - Endpoint POST `/policies/analyze`
  - Tests de integraci√≥n

- [ ] **HU-4.2**: Reglas de an√°lisis adicionales (6h)
  - Implementar detecci√≥n de wildcards
  - Implementar detecci√≥n de permisos amplios
  - Documentar reglas

**Entregables:**
- ‚úÖ Sistema de auditor√≠a completo y persistente
- ‚úÖ API REST para an√°lisis de pol√≠ticas
- ‚úÖ Dashboard de cumplimiento (frontend b√°sico)

---

### Sprint 3: Eventos de Dominio en Crates Existentes (2 semanas)

**Objetivo:** Instrumentar hodei-iam y hodei-organizations para publicar eventos

#### Semana 1
- [ ] **HU-6.1 (Parte 1)**: Instrumentar hodei-iam (8h)
  - Inyectar `EventPublisher` en todos los casos de uso de escritura
  - Definir `IamEvent` variants
  - Publicar eventos en: CreateUser, UpdateUser, DeleteUser, etc.

#### Semana 2
- [ ] **HU-6.1 (Parte 2)**: Instrumentar hodei-organizations (8h)
  - Inyectar `EventPublisher` en casos de uso de escritura
  - Definir `OrganizationEvent` variants
  - Publicar eventos en: CreateAccount, AttachScp, MoveAccount, etc.

- [ ] **Testing End-to-End**: Validar flujo de eventos (8h)
  - Tests que verifican publicaci√≥n
  - Tests que verifican suscripci√≥n
  - Tests de integraci√≥n completos

**Entregables:**
- ‚úÖ hodei-iam publicando eventos
- ‚úÖ hodei-organizations publicando eventos
- ‚úÖ Tests E2E del flujo de eventos

---

### Sprint 4: Servicio de Configuraci√≥n (Fase 1) (3 semanas)

**Objetivo:** Crear bounded context hodei-configurations con registro de cambios

#### Semana 1
- [ ] **Andamiaje del Crate** (8h)
  - Crear `crates/hodei-configurations`
  - Estructura VSA base
  - Domain model: `ConfigurationItem`, `ComplianceRule`

- [ ] **HU-6.2 (Parte 1)**: Feature record_configuration_change (12h)
  - Caso de uso para registrar cambios
  - Event handlers para consumir eventos
  - Repositorio de ConfigurationItem

#### Semana 2-3
- [ ] **HU-6.2 (Parte 2)**: Completar registro (16h)
  - Versionado de configuraciones
  - Schema de base de datos
  - Tests unitarios e integraci√≥n

**Entregables:**
- ‚úÖ Crate hodei-configurations funcional
- ‚úÖ Registro de cambios de configuraci√≥n
- ‚úÖ API REST b√°sica de consulta

---

### Sprint 5: Servicio de Configuraci√≥n (Fase 2) (3 semanas)

**Objetivo:** Motor de evaluaci√≥n de cumplimiento

#### Semana 1-2
- [ ] **HU-6.3**: Motor de cumplimiento (24h)
  - Feature evaluate_compliance
  - Integraci√≥n con Cedar para evaluar reglas
  - L√≥gica de evaluaci√≥n de ConfigurationItem

#### Semana 3
- [ ] **HU-6.4**: APIs de cumplimiento (16h)
  - Feature create_rule, list_rules
  - Feature get_compliance_details_for_resource
  - Dashboard de cumplimiento
  - Documentaci√≥n completa

**Entregables:**
- ‚úÖ Motor de cumplimiento completo
- ‚úÖ APIs de gesti√≥n de reglas
- ‚úÖ Dashboard de cumplimiento funcional

---

### Sprint 6: Producci√≥n y Escalabilidad (2 semanas)

**Objetivo:** Preparar para producci√≥n

#### Semana 1
- [ ] **HU-0.3**: Adaptador NATS (16h)
  - Crear `crates/event-bus-nats`
  - Implementar traits del bus
  - Tests de integraci√≥n con NATS

#### Semana 2
- [ ] **Optimizaci√≥n y Hardening** (16h)
  - Performance testing
  - Optimizaci√≥n de queries
  - Documentaci√≥n de deployment
  - Gu√≠as de operaci√≥n

**Entregables:**
- ‚úÖ Sistema listo para producci√≥n
- ‚úÖ Documentaci√≥n completa de deployment
- ‚úÖ Gu√≠as de troubleshooting

---

## üéØ Priorizaci√≥n y Dependencias

### Dependencias Cr√≠ticas

```
Epic 0 (Eventos) ‚îÄ‚îÄ‚îê
                   ‚îú‚îÄ‚îÄ> Epic 6 (Configuraci√≥n)
Epic 2 (Autorizaci√≥n) ‚îÄ‚îÄ‚îò

Epic 5 (Auditor√≠a) ‚îÄ‚îÄ> Epic 2 (requiere EvaluatePermissions)

Epic 4 (An√°lisis) ‚îÄ‚îÄ> (Independiente, baja prioridad)
```

### Prioridad Recomendada

1. üî¥ **Sprint 1**: Epic 0 - Infraestructura de Eventos (CR√çTICO)
2. üü† **Sprint 2**: Epic 5 - Auditor√≠a + Epic 4 - An√°lisis API
3. üü† **Sprint 3**: Epic 6 (Parte 1) - Instrumentaci√≥n de Eventos
4. üü° **Sprint 4-5**: Epic 6 (Parte 2-3) - Servicio de Configuraci√≥n
5. üü¢ **Sprint 6**: Epic 0 (NATS) - Producci√≥n

---

## üìä M√©tricas de Progreso

### Estado Global por Epic

| Epic | Progreso | Riesgo | Prioridad | Esfuerzo Restante |
|------|----------|--------|-----------|-------------------|
| Epic 0 | 10% | üî¥ Alto | CR√çTICA | 32h |
| Epic 1 | 90% | üü¢ Bajo | Alta | 2h |
| Epic 2 | 80% | üü¢ Bajo | Media | 4h |
| Epic 3 | 90% | üü¢ Bajo | Media | 4h |
| Epic 4 | 90% | üü¢ Bajo | Baja | 12h |
| Epic 5 | 0% | üü† Medio | Alta | 20h |
| Epic 6 | 0% | üî¥ Alto | CR√çTICA | 76h |

**Total Esfuerzo Restante:** ~150 horas (6 sprints de 2 semanas)

---

## ‚ö†Ô∏è Riesgos Identificados

### Riesgo 1: Complejidad del Sistema de Eventos
- **Probabilidad:** Media
- **Impacto:** Alto
- **Mitigaci√≥n:** 
  - Implementar InMemoryEventBus primero (sin NATS)
  - Tests exhaustivos antes de NATS
  - Documentaci√≥n clara de contratos

### Riesgo 2: Performance de Evaluaci√≥n Multi-capa
- **Probabilidad:** Media
- **Impacto:** Alto
- **Mitigaci√≥n:**
  - Implementar cache agresivo
  - Benchmarks desde Sprint 2
  - Optimizaci√≥n de queries SurrealDB

### Riesgo 3: Integraci√≥n NATS en Producci√≥n
- **Probabilidad:** Baja
- **Impacto:** Alto
- **Mitigaci√≥n:**
  - Posponer a Sprint 6
  - Abstraer bien los traits
  - Plan B: usar InMemoryEventBus + polling

---

## üìù Notas Importantes

### C√≥digo Legacy a Eliminar

1. **hodei-authorizer/src/ports.rs** - Eliminar completamente
2. **hodei-authorizer/src/features/evaluate_permissions/ports.rs**:
   - Eliminar trait `IamPolicyProvider`
   - Eliminar trait `OrganizationBoundaryProvider`
3. **hodei-iam/src/shared/infrastructure/surreal/iam_policy_provider.rs** - Eliminar
4. **hodei-authorizer/src/authorizer.rs** - Eliminar (usa providers legacy)

### Testing

- **Cobertura Actual:** 67 tests, 100% pasando
- **Objetivo Sprint 1:** 90+ tests
- **Objetivo Final:** 200+ tests con cobertura >80%

### Documentaci√≥n

Crear en cada sprint:
- ‚úÖ README de cada nueva feature
- ‚úÖ Diagramas de arquitectura actualizados
- ‚úÖ Gu√≠as de uso para desarrolladores
- ‚úÖ ADRs (Architecture Decision Records)

---

## üöÄ Recomendaci√≥n Ejecutiva

### Para Comenzar Inmediatamente

1. **Sprint 1 - Semana 1** (Pr√≥ximos 5 d√≠as):
   - Implementar HU-0.1 y HU-0.2 (sistema de eventos in-memory)
   - 1 desarrollador full-time
   - Entregable: Bus de eventos funcional con tests

2. **Validaci√≥n R√°pida** (1 d√≠a):
   - HU-1.6: Verificar centralizaci√≥n de HRN
   - Limpiar c√≥digo legacy (providers)

3. **Documentaci√≥n de Arquitectura** (2 d√≠as):
   - Actualizar diagramas con sistema de eventos
   - Documentar flujos de comunicaci√≥n
   - Crear ADR para decisiones de dise√±o

### Criterios de √âxito del Proyecto

- ‚úÖ 100% de tests pasando en cada sprint
- ‚úÖ Sistema de eventos robusto y testeable
- ‚úÖ Trazabilidad completa de decisiones de autorizaci√≥n
- ‚úÖ Servicio de configuraci√≥n operacional
- ‚úÖ APIs documentadas y versionadas
- ‚úÖ Performance: <100ms evaluaci√≥n de permisos p95
- ‚úÖ Escalabilidad: Soportar 1000 req/s

---

**Pr√≥ximo Paso:** Comenzar HU-0.1 - Definir abstracciones del bus de eventos