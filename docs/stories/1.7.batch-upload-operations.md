# Story 1.7: Operaciones de Subida por Lotes

## Status

✅ Implemented - Complete

## Story

**As a** CI/CD System,
**I want** to upload multiple artifacts in a single batch operation,
**so that** I can improve efficiency and reduce the number of HTTP requests when publishing a project with many modules.

## Acceptance Criteria

1. The system must provide an API endpoint for batch artifact uploads.
2. The endpoint should accept a list of artifacts (metadata and binary content) in a single request.
3. The system must process each artifact in the batch individually, applying all the same logic (validation, hashing, etc.).
4. The response should provide a status for each artifact in the batch (e.g., success or failure with a reason).
5. The operation should be atomic or transactional where possible; if one critical artifact fails, the whole batch could be rolled back.
6. The system should publish individual `ArtifactUploaded` or `ArtifactUploadFailed` events for each artifact in the batch.

## Tasks / Subtasks

- [x] Design the API for batch uploads (e.g., `POST /artifacts/batch`).
- [x] Implement the handler to iterate and process the batch.
- [x] Determine the transactionality strategy for batch operations.
- [x] Implement the response format to include individual artifact statuses.
- [x] Write integration tests for various batch scenarios (all success, partial failure, all failure).

## Dev Notes

### API Specifications
- **New Endpoint**: `POST /artifacts/batch`
- The request body is a multipart request where each part corresponds to an artifact with metadata and file content
- Supports both individual artifact processing and transactional batch processing

### Implementation Details

#### Architecture
- Follows Vertical Slice Architecture with Clean Architecture patterns
- Located in `crates/artifact/src/features/upload_batch/`
- Complete separation of concerns with DTOs, ports, use case, adapters, API, and DI container

#### Key Components
1. **BatchUploadRequest/Response DTOs** - Structured request/response formats
2. **BatchArtifactProcessor port** - Interface for processing individual artifacts
3. **BatchTransactionManager port** - Interface for transaction management
4. **BatchUploadUseCase** - Core business logic with timeout and transaction support
5. **SingleArtifactProcessor adapter** - Processes individual artifacts using existing upload infrastructure
6. **MemoryTransactionManager adapter** - In-memory transaction management for development
7. **BatchUploadApi** - Axum HTTP endpoint handler
8. **BatchUploadDIContainer** - Dependency injection with production and testing support

#### Features
- ✅ **Transactional processing** - All-or-nothing semantics with configurable timeout
- ✅ **Individual artifact status** - Detailed response for each artifact in batch
- ✅ **Error handling** - Comprehensive error types and HTTP status mapping
- ✅ **Timeout support** - Configurable timeout for batch operations
- ✅ **Test coverage** - Comprehensive unit and integration tests
- ✅ **Dependency injection** - Flexible adapter configuration for different environments

#### API Endpoint
```rust
POST /artifacts/batch
Content-Type: multipart/form-data

// Multiple parts with:
// - metadata: JSON string with artifact metadata
// - file: binary content of the artifact
```

#### Response Format
```json
{
  "batch_id": "uuid",
  "status": "completed|partial|failed",
  "artifacts": [
    {
      "artifact_id": "coordinates",
      "status": "success|failed",
      "error": null|"error message",
      "hrn": "human-readable-name"
    }
  ],
  "total_count": 5,
  "success_count": 4,
  "failure_count": 1
}
```

#### Testing
- Unit tests for all components
- Integration tests covering:
  - Successful batch uploads
  - Partial failures
  - Complete failures
  - Timeout scenarios
  - Transaction rollback behavior

#### Configuration
- Feature flag: `upload_batch` in Cargo.toml
- Timeout configurable via environment variable `HODEI_BATCH_UPLOAD_TIMEOUT_MS` (default: 30000ms)
- Transaction mode configurable (memory for development, database for production)