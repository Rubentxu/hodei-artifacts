# Historia 4.19: Policy Performance Monitoring

## Estado
- **Borrador (Draft)**

## Historia
**Como** ingeniero de fiabilidad de sitio (SRE),
**quiero** monitorear las métricas de rendimiento del sistema de autorización, como la latencia de evaluación y la tasa de acierto de la caché,
**para que** pueda asegurar que el sistema cumple con los SLAs y detectar degradaciones de rendimiento.

## Criterios de Aceptación
1.  El `AuthorizationService` ha sido instrumentado para medir la duración (latencia) de cada evaluación de política.
2.  El `AccessDecisionCache` ha sido instrumentado para medir la tasa de aciertos y fallos (hit/miss rate) de la caché local y la de Redis.
3.  Estas métricas se exponen en un formato compatible con Prometheus (p. ej., a través de un endpoint `/metrics`).
4.  Las métricas de latencia de evaluación se registran como histogramas para poder calcular percentiles (p50, p90, p99).
5.  [cite_start]Se publica un evento `PolicyEvaluationTimed` después de cada evaluación, conteniendo la duración. [cite: 25]

## Tareas / Subtareas
- [ ] **Tarea 1: Añadir Dependencia de Métricas**
    - [ ] Integrar una librería de métricas compatible con Prometheus (p. ej., `prometheus` o `metrics`).
- [ ] **Tarea 2: Instrumentar el Servicio de Autorización** (AC: #1, #4)
    - [ ] En el método `is_authorized`, añadir lógica para medir el tiempo de inicio y fin de la evaluación de Cedar.
    - [ ] Registrar la duración en un histograma de Prometheus.
- [ ] **Tarea 3: Instrumentar el Servicio de Caché** (AC: #2)
    - [ ] En el método `get_decision` del `AccessDecisionCache`, incrementar contadores de Prometheus para aciertos (local/redis) y fallos.
- [ ] **Tarea 4: Exponer el Endpoint de Métricas** (AC: #3)
    - [ ] Crear y exponer un endpoint `/metrics` en el servidor de la aplicación que devuelva las métricas en el formato de texto de Prometheus.
- [ ] **Tarea 5: Publicar Evento de Dominio** (AC: #5)
    - [ ] Tras registrar la métrica de latencia, publicar el evento `PolicyEvaluationTimed`.
- [ ] **Tarea 6: Añadir Pruebas**
    - [ ] Escribir pruebas de integración que realicen varias solicitudes de autorización y luego consulten el endpoint `/metrics` para verificar que los contadores y histogramas se han actualizado correctamente.

## Notas para el Desarrollador
La observabilidad es clave para mantener un sistema de autorización de alto rendimiento y alta disponibilidad. Esta historia proporciona los datos necesarios para ello.

### Métricas Clave
* [cite_start]Las métricas de éxito de la Épica E4 especifican una **latencia de decisión <2ms** y una **eficiencia de caché >90%**. [cite: 25] La instrumentación de esta historia es lo que nos permitirá medir si estamos cumpliendo esos objetivos.
* Utilizar histogramas para la latencia es importante porque nos permite ver no solo la media, sino también el rendimiento en el peor de los casos (percentiles altos).

