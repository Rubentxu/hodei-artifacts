# Story 5.13: Repository Backup/Restore

## Status
- Draft

## Story
**Como** un Administrador de Sistemas / SRE,
**quiero** tener un sistema fiable para crear copias de seguridad completas de todo el sistema y un procedimiento claro para restaurarlas,
**para** garantizar la continuidad del negocio y poder recuperarme de un fallo catastrófico de hardware o un error humano.

## Acceptance Criteria
1.  Un administrador puede iniciar un trabajo de copia de seguridad completa a través de la API o un job programado.
2.  El trabajo de copia de seguridad debe producir un "punto de recuperación" consistente, que incluya tanto un volcado de la base de datos de metadatos (MongoDB) como una referencia a una instantánea o réplica del almacenamiento de artefactos (S3).
3.  El sistema debe ser capaz de listar los puntos de recuperación disponibles para una posible restauración.
4.  Debe existir una herramienta de línea de comandos (CLI) para operadores que permita realizar una restauración completa a partir de un punto de recuperación.
5.  El proceso de restauración debe recrear el estado del sistema (usuarios, repositorios, artefactos) tal como estaba en el momento de la copia de seguridad.
6.  Debe existir documentación detallada que describa el procedimiento de recuperación ante desastres.

## Tasks / Subtasks
- [ ] Tarea 1: Desarrollar el servicio de orquestación de copias de seguridad. (AC: 1, 2)
    - [ ] Subtarea 1.1: Crear un `BackupService` que encapsule la lógica de backup.
    - [ ] Subtarea 1.2: Implementar la lógica para ejecutar `mongodump` mediante un subproceso y guardar el resultado comprimido en una ubicación segura de S3 (un "bucket" de backups).
    - [ ] Subtarea 1.3: Implementar la lógica para interactuar con la API del proveedor de cloud (ej: AWS SDK) para iniciar una operación nativa de snapshot o replicación del bucket principal de artefactos.
    - [ ] Subtarea 1.4: Crear un "manifiesto de backup" (un archivo JSON) que contenga las rutas al volcado de la base de datos y el ID de la instantánea del almacenamiento, guardándolo también en el bucket de backups.
- [ ] Tarea 2: Integrar el servicio con la API y el planificador de trabajos. (AC: 1, 3)
    - [ ] Subtarea 2.1: Crear un endpoint `POST /api/v1/system/backups` para iniciar un trabajo de backup de forma manual.
    - [ ] Subtarea 2.2: Crear un endpoint `GET /api/v1/system/backups` que liste los manifiestos de backup disponibles.
    - [ ] Subtarea 2.3: Configurar un job programado (ej: diariamente a las 03:00) que ejecute el `BackupService`.
- [ ] Tarea 3: Desarrollar la herramienta CLI de restauración. (AC: 4, 5)
    - [ ] Subtarea 3.1: Crear un nuevo binario `restore-tool` en el workspace de Cargo.
    - [ ] Subtarea 3.2: La herramienta debe aceptar como argumento el ID de un punto de recuperación.
    - [ ] Subtarea 3.3: Implementar la lógica para descargar el manifiesto, el volcado de la base de datos, y ejecutar `mongorestore`.
    - [ ] Subtarea 3.4: Implementar la lógica para iniciar la restauración del almacenamiento de artefactos a partir de la instantánea referenciada en el manifiesto.
- [ ] Tarea 4: Documentar el proceso de recuperación. (AC: 6)
    - [ ] Subtarea 4.1: Escribir un documento `DISASTER_RECOVERY.md` que explique paso a paso cómo usar la `restore-tool`, los prerrequisitos y las comprobaciones post-restauración.
- [ ] Tarea 5: Pruebas.
    - [ ] Subtarea 5.1: Probar que el job de backup crea correctamente el volcado de la DB y el manifiesto.
    - [ ] Subtarea 5.2: Realizar una prueba de integración de ciclo completo en un entorno de staging: crear datos, ejecutar el backup, destruir los datos, ejecutar la restauración y verificar que los datos se han recuperado íntegramente.

## Dev Notes

### Guía de Implementación y Contexto Arquitectónico

**Decisión Arquitectónica Clave: Orquestar, no Reimplementar**
No intentes construir tu propia lógica para copiar terabytes de artefactos. Es ineficiente y propenso a errores. La estrategia correcta es **orquestar las herramientas nativas y probadas** que ya existen:
-   **Metadatos**: Usa `mongodump` y `mongorestore`. Son las herramientas oficiales, rápidas y fiables para MongoDB.
-   **Artefactos**: Usa las capacidades de tu proveedor de cloud. Si usas AWS S3, utiliza S3 Cross-Region Replication para una réplica en vivo o las API de S3 para crear snapshots/puntos de restauración. Son operaciones optimizadas a nivel de infraestructura.
-   El valor de nuestro servicio es la **coordinación** que garantiza que ambos backups son consistentes en el tiempo.

**Flujo de Backup (Job en segundo plano):**
1.  **(Opcional) Poner el sistema en modo solo-lectura.**
2.  **Ejecutar `mongodump`** de las colecciones relevantes. Comprimir el resultado (`.gz`).
3.  **Subir el dump** a un bucket S3 dedicado para backups (ej. `my-app-backups`).
4.  **Iniciar el snapshot/replicación** del bucket S3 principal (ej. `my-app-artifacts`).
5.  **Crear el manifiesto**: `recovery-point-20250910T0300.json` con las rutas a los resultados de los pasos 3 y 4.
6.  **Subir el manifiesto** al bucket de backups.
7.  **(Opcional) Quitar el modo solo-lectura.**

**Herramienta de Restauración (CLI):**
La restauración es una operación demasiado sensible y destructiva para una API. Una herramienta CLI para operadores es mucho más segura. Requiere confirmaciones explícitas (`"¿Estás seguro de que quieres sobreescribir la base de datos? [y/N]"`) y puede proporcionar un output detallado del progreso.

**Consideraciones sobre Backups Incrementales:**
Esta historia se centra en el backup completo. Los backups incrementales son más complejos. Para MongoDB, se basan en el `oplog`. Para S3, se basan en el versionado de objetos. Serían una mejora futura sobre esta base.