# Historia 4.23: External Identity Integration

## Estado
- **Borrador (Draft)**

## Historia
**Como** administrador de una empresa,
**quiero** integrar el sistema con nuestro proveedor de identidad externo (p. ej., OIDC, LDAP),
**para que** los usuarios puedan autenticarse con sus credenciales corporativas existentes (Single Sign-On).

## Criterios de Aceptación
1.  Se ha implementado una abstracción `IdentityProvider` que puede gestionar múltiples protocolos de autenticación (OIDC, LDAP, SAML, e Interno).
2.  El sistema puede ser configurado con los detalles de un proveedor de identidad externo (p. ej., OIDC-issuer-url, client-id).
3.  Se ha implementado el flujo de autenticación para al menos un protocolo, preferiblemente OIDC.
4.  Cuando un usuario se autentica a través de un proveedor externo por primera vez, se crea una cuenta de usuario interna "sombra" (shadow account) en el sistema.
5.  Los atributos del usuario (p. ej., membresías a grupos) se pueden sincronizar desde el proveedor externo a la cuenta interna.
6.  Se publica un evento `ExternalIdentityLinked` cuando una cuenta externa se vincula a una interna.
7.  Se publica un evento `SSOAuthenticationCompleted` en un inicio de sesión exitoso a través de SSO.

## Tareas / Subtareas
- [ ] **Tarea 1: Añadir Dependencias de Identidad**
    - [ ] Añadir las dependencias `openidconnect = "3.0"` y `ldap3 = "0.11"` al `Cargo.toml`.
- [ ] **Tarea 2: Implementar la Abstracción del Proveedor** (AC: #1)
    - [ ] Implementar el `enum IdentityProvider` y el trait correspondiente siguiendo el patrón de la investigación técnica.
- [ ] **Tarea 3: Implementar el Flujo OIDC** (AC: #3)
    - [ ] Crear un cliente OIDC que pueda manejar el flujo de código de autorización (authorization code flow).
    - [ ] Implementar los endpoints de callback de la API necesarios para que el proveedor de OIDC redirija al usuario.
- [ ] **Tarea 4: Implementar el Provisionamiento de Usuarios Sombra** (AC: #4, #5)
    - [ ] Tras una autenticación OIDC exitosa, implementar la lógica para buscar un usuario interno por email o ID externo.
    - [ ] Si el usuario no existe, crearlo. Si existe, actualizar sus atributos (p. ej., grupos) a partir de la información del token de OIDC.
- [ ] **Tarea 5: Integrar con la API de Login**
    - [ ] Modificar el endpoint de login principal para que pueda iniciar un flujo de redirección a un proveedor externo.
- [ ] **Tarea 6: Publicar Eventos de Dominio** (AC: #6, #7)
    - [ ] Integrar la publicación de los eventos `ExternalIdentityLinked` y `SSOAuthenticationCompleted` en los puntos apropiados del flujo.
- [ ] **Tarea 7: Añadir Pruebas**
    - [ ] Dado que probar flujos de SSO es complejo, crear pruebas de integración que utilicen un servidor OIDC simulado (mock) para verificar el flujo completo.

## Notas para el Desarrollador
Esta historia es compleja y requiere conocimientos de protocolos de autenticación federada.

### Patrón de Implementación
* El diseño debe ser modular para soportar múltiples proveedores. El `enum IdentityProvider` sugerido en la investigación técnica es el enfoque correcto.
    ```rust
    // Pseudocódigo de referencia para el proveedor de identidad
    // Fuente: Investigación Técnica de la Épica E4
    enum IdentityProvider {
        OpenIdConnect(OpenIdClient),
        Ldap(LdapConnection),
        Saml(SamlServiceProvider),
        Internal,
    }

    impl IdentityProvider {
        async fn authenticate(&self, credentials: &Credentials) -> Result<Principal> {
            // ...
        }
    }
    ```
### Sincronización de Atributos
* Una parte clave es la sincronización de atributos (especialmente grupos) desde el proveedor externo. Los `claims` en un token de OIDC o los atributos de un registro LDAP son la fuente de verdad. Esta información debe mapearse a los atributos del `User` interno para que Cedar pueda usarla en las políticas.

