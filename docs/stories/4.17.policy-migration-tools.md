# Historia 4.17: Policy Migration Tools

## Estado
- **Brorrador (Draft)**

## Historia
**Como** administrador del sistema,
**quiero** herramientas para importar y exportar políticas de Cedar de forma masiva,
**para que** pueda realizar copias de seguridad, restauraciones y migraciones de políticas de manera eficiente.

## Criterios de Aceptación
1.  Existe un endpoint de API (`GET /api/v1/policies/export`) que exporta todas las políticas activas en un formato de archivo definido (p. ej., JSON array).
2.  Existe un endpoint de API (`POST /api/v1/policies/import`) que importa un conjunto de políticas desde un archivo.
3.  La operación de importación valida cada política del archivo antes de guardarla, utilizando el `PolicyValidationService`.
4.  La operación de importación ofrece diferentes estrategias para manejar conflictos (p. ej., `skip` si ya existe, `overwrite` la versión activa).
5.  La operación de importación es transaccional: si una política en el archivo es inválida, ninguna política del archivo se importa.
6.  Se publica un evento `PoliciesMigrated` al finalizar una importación o exportación exitosa.

## Tareas / Subtareas
- [ ] **Tarea 1: Implementar el Servicio de Migración**
    - [ ] Crear un `PolicyMigrationService` que contenga la lógica de negocio para la importación y exportación.
    - [ ] El servicio debe utilizar el `PolicyRepository` y el `PolicyValidationService`.
- [ ] **Tarea 2: Implementar la Lógica de Exportación** (AC: #1)
    - [ ] Implementar un método en el servicio que obtenga todas las políticas activas y las serialize a un formato JSON.
- [ ] **Tarea 3: Implementar la Lógica de Importación** (AC: #2, #3, #4, #5)
    - [ ] Implementar un método en el servicio que lea un archivo de políticas.
    - [ ] El método debe iterar sobre las políticas, validarlas y aplicar la estrategia de conflicto especificada.
    - [ ] Asegurarse de que la operación se revierta si se encuentra un error a mitad del proceso.
- [ ] **Tarea 4: Implementar los Endpoints de la API**
    - [ ] Añadir e implementar los endpoints de importación y exportación en la especificación OpenAPI.
- [ ] **Tarea 5: Publicar Evento de Dominio** (AC: #6)
    - [ ] Integrar la publicación del evento `PoliciesMigrated` al final de una operación exitosa.
- [ ] **Tarea 6: Añadir Pruebas**
    - [ ] Escribir pruebas de integración para el flujo de exportación e importación, probando las diferentes estrategias de conflicto y el caso de un archivo con políticas inválidas.

## Notas para el Desarrollador
Esta historia se centra en la operatividad del sistema a largo plazo.

### Formato de Archivo
* Se debe definir un formato claro para la importación/exportación. Un array de objetos JSON, donde cada objeto contiene el contenido de la política y sus metadatos, es una opción robusta.

### Manejo de Errores
* El manejo de errores en la importación es crítico. Una importación masiva no debe dejar el sistema en un estado inconsistente. La operación debe ser atómica (todo o nada).
