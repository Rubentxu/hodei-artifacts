# Story 1.10: Detección de Content-Type

## Status

✅ **Implemented** - Complete VSA implementation with magic number detection

## Story

**As a** System,
**I want** to automatically and accurately detect the MIME type of an uploaded artifact, even if the client provides an incorrect `Content-Type` header,
**so that** artifacts are stored with the correct MIME type, enabling proper handling by browsers and other tools.

## Acceptance Criteria

✅ **1.** The system must inspect the file's magic numbers (the first few bytes of the file) to determine its true MIME type.
✅ **2.** This detection should happen server-side after the upload begins.
✅ **3.** The detected MIME type should be stored in the artifact's metadata.
✅ **4.** The system should use a reliable library (e.g., `infer`) for this purpose.
✅ **5.** If the client-provided `Content-Type` header mismatches the detected type, the detected type should take precedence, and a warning may be logged.
✅ **6.** The detection should be performant and not significantly impact upload times.

## Implementation Details

### Architecture
- **Vertical Slice Architecture**: Complete feature isolation in `crates/artifact/src/features/content_type_detection/`
- **Hexagonal Architecture**: Clear separation of ports and adapters
- **Dependency Injection**: Proper DI configuration for production and testing

### Components
- **Service**: `ContentTypeDetectionService` coordinates detection and validation
- **Detector**: `InferContentTypeDetector` using `infer` crate for magic number detection
- **API**: HTTP endpoints for direct content-type detection
- **Integration**: Seamlessly integrated into upload artifact workflow

### Features
- Magic number detection as primary method
- Filename extension fallback detection
- Content-Type header validation and mismatch logging
- Performance optimized (only reads necessary bytes)

## Tasks / Subtasks

✅ **Integrate magic number detection library**: Added `infer = "0.19.0"` dependency
✅ **Add upload workflow step**: Integrated into both `execute` and `execute_from_temp_file` methods
✅ **Store MIME type in metadata**: Added `mime_type` field to `PhysicalArtifact` domain model
✅ **Implement Content-Type mismatch logging**: Complete validation with warning logging
✅ **Write unit tests**: Basic detection tests implemented (additional tests pending)

## Technical Implementation

### Domain Changes
- Added `mime_type: String` field to `PhysicalArtifact` struct
- Updated MongoDB repository to store and retrieve MIME type

### Integration Points
- **UploadArtifactUseCase**: Content-type detection after checksum calculation
- **DI Configuration**: ContentTypeDetectionService injected into upload workflow
- **Error Handling**: Proper error propagation with meaningful messages

### Performance
- Detection happens on small file chunks (magic numbers only)
- Minimal impact on upload performance
- Async/await non-blocking implementation

## Dev Notes

### Technical Constraints
✅ **Wide format support**: `infer` crate supports JAR, ZIP, GZ, PNG, PDF, and many other common formats
✅ **Efficient processing**: Only reads magic numbers (first few bytes), minimal memory usage

### Implementation Details
- **VSA Compliance**: Full Vertical Slice Architecture with isolated feature directory
- **Error Handling**: Comprehensive error types with proper conversion to upload errors
- **Logging**: Structured logging with tracing for both successes and mismatches
- **Testing**: Mock-friendly design with proper dependency injection

### Files Created/Modified

#### New Files (VSA Structure):
- `crates/artifact/src/features/content_type_detection/adapter.rs` - Infer-based detector
- `crates/artifact/src/features/content_type_detection/api.rs` - HTTP endpoints
- `crates/artifact/src/features/content_type_detection/di.rs` - Dependency injection
- `crates/artifact/src/features/content_type_detection/dto.rs` - Data transfer objects
- `crates/artifact/src/features/content_type_detection/error.rs` - Error types
- `crates/artifact/src/features/content_type_detection/ports.rs` - Interface definitions
- `crates/artifact/src/features/content_type_detection/service.rs` - Core service logic
- `crates/artifact/src/features/content_type_detection/mod.rs` - Module exports

#### Modified Files:
- `crates/artifact/src/domain/physical_artifact.rs` - Added `mime_type` field
- `crates/artifact/src/features/upload_artifact/use_case.rs` - Integrated detection
- `crates/artifact/src/features/upload_artifact/di.rs` - Updated DI configuration
- `Cargo.toml` - Added `infer` dependency to workspace
- `crates/artifact/Cargo.toml` - Added `infer` dependency

### Usage

The content-type detection is automatically integrated into all artifact uploads. The system:

1. Calculates SHA-256 checksum
2. Detects MIME type using magic numbers + extension fallback
3. Stores detected type in PhysicalArtifact metadata
4. Proceeds with normal upload workflow

For manual testing, HTTP endpoints are available at:
- `POST /api/v1/content-type/detect` - Detect from bytes
- `POST /api/v1/content-type/detect-from-file` - Detect from uploaded file
- `GET /api/v1/content-type/detect-from-extension/{filename}` - Detect from extension