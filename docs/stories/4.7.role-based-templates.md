# Historia 4.7: Role-Based Templates

## Estado
- **Borrador (Draft)**

## Historia
**Como** administrador del sistema,
**quiero** usar plantillas de roles predefinidos (p. ej., "Lector", "Administrador"),
**para que** pueda asignar conjuntos de permisos comunes a usuarios o grupos de forma rápida y consistente.

## Criterios de Aceptación
1.  Se ha definido un modelo de datos para `RoleTemplate`, que contiene un nombre, una descripción y una lista de plantillas de políticas de Cedar.
2.  Las plantillas de políticas pueden contener variables (p. ej., `?principal`, `?resource`) que serán reemplazadas al aplicar el rol.
3.  Existe un servicio `RoleTemplateService` que puede aplicar un rol a un `principal` (usuario o grupo) sobre un `resource` (o un ámbito de recursos).
4.  Al aplicar un rol, el servicio genera políticas de Cedar concretas a partir de las plantillas, sustituyendo las variables por los valores proporcionados.
5.  Las políticas generadas se almacenan utilizando el `PolicyRepository` de la historia `4.2`.
6.  Se publica un evento `RoleTemplateApplied` que contiene la plantilla utilizada y las políticas que se han creado.
7.  Existen endpoints de API para gestionar las plantillas de roles (CRUD) y para aplicarlas.

## Tareas / Subtareas
- [ ] **Tarea 1: Definir el Modelo y Repositorio de Plantillas** (AC: #1)
    - [ ] Definir la estructura `RoleTemplate`.
    - [ ] Crear un `RoleTemplateRepository` con operaciones CRUD y una implementación en memoria.
- [ ] **Tarea 2: Implementar el Servicio de Aplicación de Roles** (AC: #2, #3, #4, #5)
    - [ ] Crear el `RoleTemplateService`.
    - [ ] Implementar un método `apply_role` que tome un ID de plantilla, un `principal` y un `resource`.
    - [ ] La lógica de este método debe leer la plantilla, realizar la sustitución de variables y crear las políticas resultantes a través del `PolicyRepository`.
- [ ] **Tarea 3: Definir y Implementar Endpoints de API** (AC: #7)
    - [ ] Añadir endpoints CRUD para `/api/v1/roles` en la especificación OpenAPI.
    - [ ] Añadir un endpoint `POST /api/v1/roles/apply` para aplicar una plantilla.
    - [ ] Implementar los handlers para la gestión y aplicación de roles.
- [ ] **Tarea 4: Publicar Eventos de Dominio** (AC: #6)
    - [ ] Integrar la publicación del evento `RoleTemplateApplied` en el `RoleTemplateService`.
- [ ] **Tarea 5: Añadir Pruebas**
    - [ ] Escribir pruebas unitarias para la lógica de sustitución de variables.
    - [ ] Escribir pruebas de integración que apliquen un rol vía API y verifiquen que las políticas de Cedar correctas se han creado en el `PolicyRepository`.

## Notas para el Desarrollador
Esta historia crea una abstracción útil sobre el sistema de políticas. En lugar de forzar a los administradores a escribir Cedar para cada caso, los roles proporcionan "recetas" de permisos reutilizables.

### Lógica de Plantillas
* Una plantilla de política podría tener este aspecto: `permit (principal == ?principal, action == Action::"read", resource in ?resource);`.
* Al aplicar el rol "Lector" (`?principal` = `User::"bob"`, `?resource` = `Repository::"project-x"`), el servicio generaría la política concreta: `permit (principal == User::"bob", action == Action::"read", resource in Repository::"project-x");`.