### **Historia 4.8: Policy Testing Framework**

#### **Proceso de Creación**
* **Identificada siguiente historia:** 4.8 - Policy Testing Framework.
* **Recopilación:** Esta historia es fundamental para la fiabilidad del sistema. Se basa directamente en la detallada especificación técnica para un "sandbox" de pruebas de políticas, permitiendo a los administradores simular el efecto de una política antes de aplicarla.
* **Checklist:** Ejecutando la `story-draft-checklist`... **Resultado:** ✅ **LISTA**.

#### **Archivo: `docs/stories/4.8.Policy-Testing-Framework.md`**

# Historia 4.8: Policy Testing Framework

## Estado
- **Borrador (Draft)**

## Historia
**Como** administrador de políticas,
**quiero** probar una política en un entorno "sandbox" con datos simulados,
**para que** pueda verificar su comportamiento y entender su impacto antes de guardarla en el sistema.

## Criterios de Aceptación
1.  Se ha creado un `PolicyTestSandbox` que puede evaluar una política contra un conjunto de entidades y solicitudes simuladas.
2.  Existe un endpoint de API (p. ej., `POST /api/v1/policies/test`) que acepta una política, un conjunto de entidades simuladas (principals, resources) y un conjunto de escenarios de prueba.
3.  Cada escenario de prueba consiste en una solicitud de autorización (principal, acción, recurso) y el resultado esperado (`Allow`/`Deny`).
4.  El sandbox evalúa la política para cada escenario y devuelve un informe que compara el resultado real con el esperado.
5.  La evaluación dentro del sandbox está completamente aislada y no afecta al estado real del sistema (no usa el `PolicyRepository` ni la caché de decisiones).
6.  Se publican los eventos `PolicyTested` y `TestScenarioExecuted` para fines de auditoría.

## Tareas / Subtareas
- [ ] **Tarea 1: Implementar el Sandbox de Pruebas** (AC: #1)
    - [ ] Crear la estructura `PolicyTestSandbox` siguiendo el patrón de la investigación técnica.
    - [ ] El sandbox debe contener una instancia efímera del motor de Cedar.
- [ ] **Tarea 2: Definir Estructuras de Datos para Pruebas** (AC: #3)
    - [ ] Crear estructuras para `TestScenario` (política a probar, entidades simuladas) y `TestCase` (solicitud + resultado esperado).
- [ ] **Tarea 3: Implementar la Lógica de Evaluación Aislada** (AC: #4, #5)
    - [ ] Implementar el método principal del sandbox, `test_policy_scenario`, que toma un escenario y devuelve un `TestResult`.
    - [ ] La lógica debe cargar las entidades simuladas y la política en el motor de Cedar y ejecutar las evaluaciones de los casos de prueba.
- [ ] **Tarea 4: Definir e Implementar el Endpoint de la API** (AC: #2)
    - [ ] Añadir el endpoint `POST /api/v1/policies/test` a la especificación OpenAPI.
    - [ ] Implementar el handler que recibe el escenario de prueba, lo ejecuta a través del `PolicyTestSandbox` y devuelve el informe de resultados.
- [ ] **Tarea 5: Publicar Eventos de Auditoría** (AC: #6)
    - [ ] Integrar la publicación de los eventos `PolicyTested` y `TestScenarioExecuted` en el handler de la API.
- [ ] **Tarea 6: Añadir Pruebas**
    - [ ] Escribir pruebas unitarias para el `PolicyTestSandbox`, verificando que compara correctamente los resultados reales y esperados.
    - [ ] Escribir pruebas de integración para el endpoint de la API.

## Notas para el Desarrollador
Esta es una característica de seguridad y fiabilidad crítica. Un administrador debe tener total confianza en que una política funcionará como se espera. La implementación debe seguir de cerca el patrón detallado en la investigación técnica.

### Patrón de Implementación del Sandbox
* Utilizar el diseño `PolicyTestSandbox` de la investigación técnica como guía directa. El concepto clave es la **evaluación aislada**.
    ```rust
    // Pseudocódigo de referencia para el sandbox
    // Fuente: Investigación Técnica de la Épica E4
    struct PolicyTestSandbox {
        policy_engine: Arc<dyn PolicyEngine>, // Instancia efímera
        mock_entities: HashMap<String, Entity>,
        test_scenarios: Vec<TestScenario>,
    }

    impl PolicyTestSandbox {
        async fn test_policy_scenario(&self, scenario: &TestScenario) -> Result<TestResult> {
            // ...lógica para evaluar casos de prueba con entidades simuladas...
        }
    }
    ```

### Interfaz de la API
* La API debe ser clara. El `body` de la petición `POST` debe contener todo lo necesario para la prueba: la cadena de la política, un array de entidades `mock` en formato JSON y un array de casos de prueba.