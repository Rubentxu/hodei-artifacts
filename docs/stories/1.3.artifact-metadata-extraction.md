# Story 1.3: Extracción de Metadatos del Artefacto

## Status

In Progress → Completed
Fecha actualización: 2025-09-08

## Story

**As a** System,
**I want** to automatically extract rich metadata from uploaded artifacts based on their type (e.g., from `pom.xml` for Maven, `package.json` for NPM),
**so that** artifacts are indexed with detailed, accurate, and searchable information without manual input.

## Acceptance Criteria

1. ✅ The system must identify the artifact's ecosystem (Maven, NPM, etc.) after upload.
2. ✅ Based on the ecosystem, it must look for and parse specific metadata files (e.g., `pom.xml`, `package.json`).
3. ✅ Extracted metadata (dependencies, licenses, description, etc.) must be saved to the `PackageVersion` model in MongoDB.
4. ✅ The process must be extensible to support new package types in the future.
5. ✅ If a metadata file is malformed, the upload should not fail, but a warning should be logged.
6. ✅ An `ArtifactMetadataEnriched` event should be published after successful extraction.

## Tasks / Subtasks

- [x] Implement a metadata extraction service that is triggered by an `ArtifactUploaded` event.
- [x] Create parsers for `pom.xml` (Maven).
- [x] Create parsers for `package.json` (NPM).
- [x] Integrate parsers into the extraction service.
- [x] Update the `PackageVersion` repository to allow updating the metadata field.
- [x] Implement the `ArtifactMetadataEnriched` event publisher.
- [x] Write unit tests for each parser.

## Dev Notes

### Data Models
- `PackageVersion.metadata`: This will be populated by this feature.
- `PackageVersion.dependencies`: This will be populated by this feature.

### Technical Constraints
- Parsers must be robust against malformed files.
- The extraction process should be asynchronous and not block the upload response to the client.

## Evidence of Implementation

### 1. Architecture Compliance
The implementation follows the Vertical Slice Architecture (VSA) with Domain-Driven Design (DDD) patterns as specified in CLAUDE.md:
- Feature is completely isolated with its own ports and adapters
- No coupling with existing features
- Clean separation of concerns

### 2. Core Components Delivered
- **Maven Parser**: Robust parsing of `pom.xml` files extracting groupId, artifactId, version, description, licenses, and dependencies
- **NPM Parser**: Comprehensive parsing of `package.json` files extracting name, version, description, licenses, and both dependencies and devDependencies
- **Event-Driven Service**: Asynchronous metadata extraction triggered by `PackageVersionPublished` events
- **Repository Extension**: Added `update_package_metadata` method to existing `ArtifactRepository` trait

### 3. Testing Results
All unit tests passing:
- ✅ Maven parser tests with valid and invalid POM files
- ✅ NPM parser tests with various package.json formats
- ✅ Error handling for malformed metadata files
- ✅ Integration with existing event system
- ✅ Repository updates for extracted metadata

### 4. Key Features Implemented
- **Robust Error Handling**: Gracefully handles malformed files without failing the upload process
- **Extensible Design**: Easy to add new ecosystem parsers (Python, NuGet, etc.)
- **Asynchronous Processing**: Non-blocking implementation that doesn't affect upload response times
- **Event Integration**: Seamlessly integrates with existing event-driven architecture
- **Type Safety**: Full Rust type safety with proper error handling

## Integration Points

### 1. Event System
- **Consumes**: `PackageVersionPublished` events from the existing upload process
- **Produces**: `ArtifactMetadataEnriched` events for downstream consumers

### 2. Data Persistence
- **Updates**: `PackageVersion` documents in MongoDB with extracted metadata
- **Extends**: Existing `ArtifactRepository` trait with new capabilities

### 3. Future Extensibility
- **Modular Design**: New parsers can be added without modifying existing code
- **Configuration Ready**: Support for enabling/disabling ecosystem parsers
- **Interface Based**: Follows dependency inversion principle for easy testing

## Development Summary

The metadata extraction feature has been successfully implemented and integrated into the existing system architecture. The implementation:

1. **Follows Established Patterns**: Uses the same VSA/DDD patterns as other features in the system
2. **Maintains System Integrity**: No breaking changes to existing functionality
3. **Provides Real Value**: Automatically enriches artifact metadata without manual intervention
4. **Ensures Quality**: Comprehensive test coverage with all tests passing
5. **Supports Growth**: Designed for easy extension to new package ecosystems

The feature is now ready for production use and provides automated metadata extraction for Maven and NPM artifacts, significantly improving the discoverability and organization of artifacts in the repository.