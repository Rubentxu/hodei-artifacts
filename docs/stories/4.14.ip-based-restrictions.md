### **Historia 4.14: IP-Based Restrictions**

#### **Proceso de Creación**
* **Identificada siguiente historia:** 4.14 - IP-Based Restrictions.
* **Recopilación:** Similar a la historia anterior, esta característica también enriquece el contexto de evaluación de Cedar. En este caso, se añade la dirección IP de origen de la solicitud, permitiendo políticas basadas en la red.
* **Checklist:** Ejecutando la `story-draft-checklist`... **Resultado:** ✅ **LISTA**.

#### **Archivo: `docs/stories/4.14.IP-Based-Restrictions.md`**

# Historia 4.14: IP-Based Restrictions

## Estado
- **Borrador (Draft)**

## Historia
**Como** administrador de seguridad,
**quiero** crear políticas que restrinjan el acceso basándose en la dirección IP de origen de la solicitud,
**para que** pueda limitar el acceso a recursos sensibles solo a redes de confianza (p. ej., la red corporativa).

## Criterios de Aceptación
1.  La capa de la aplicación que recibe las solicitudes (p. ej., middleware de la API) extrae la dirección IP del cliente.
2.  El `AuthorizationService` se ha modificado para aceptar la dirección IP de origen como parte del `context` de la evaluación.
3.  Es posible crear y aplicar una política de Cedar que utilice la dirección IP del contexto para permitir o denegar el acceso (p. ej., `when { context.ip_address.in_range("192.168.1.0/24") }`).
4.  Una solicitud desde una IP permitida es autorizada (`Allow`).
5.  Una solicitud desde una IP no permitida es denegada (`Deny`).
6.  Se publica un evento `IPAccessChecked` con la IP y el resultado de la evaluación.

## Tareas / Subtareas
- [ ] **Tarea 1: Extraer la IP de Origen** (AC: #1)
    - [ ] Implementar o configurar un middleware en el framework de la API para obtener la dirección IP de cada solicitud entrante.
- [ ] **Tarea 2: Modificar la Interfaz de Evaluación** (AC: #2)
    - [ ] Actualizar el método `is_authorized` para que acepte parámetros de contexto adicionales, como la IP de origen.
    - [ ] El método debe añadir la dirección IP al objeto `context` de Cedar antes de la evaluación.
- [ ] **Tarea 3: Implementar la Lógica de Contexto** (AC: #3)
    - [ ] Asegurarse de que el atributo `ip_address` se añade al `context` de una forma que Cedar pueda interpretar (p. ej., usando la extensión `ipaddr`).
- [ ] **Tarea 4: Publicar Evento de Dominio** (AC: #6)
    - [ ] Tras una evaluación que involucre una política de IP, publicar el evento `IPAccessChecked`.
- [ ] **Tarea 5: Añadir Pruebas de Integración** (AC: #3, #4, #5)
    - [ ] Escribir pruebas de integración que definan una política basada en IP.
    - [ ] Simular llamadas a la API desde diferentes direcciones IP (una permitida y una denegada) y verificar que la política se evalúa correctamente.

## Notas para el Desarrollador
Esta historia, al igual que la 4.13, se basa en enriquecer el `contexto` de evaluación de Cedar. La lógica es muy similar: capturar información del entorno de la solicitud y pasarla al motor de políticas.

### Extensión `ipaddr` de Cedar
* Para que Cedar pueda realizar operaciones con direcciones IP (como `in_range`), es necesario utilizar el tipo de extensión `ipaddr`.
* El `context` debe construirse de una manera específica:
    ```rust
    // Lógica conceptual para añadir la IP al contexto
    let request_context = cedar_policy::Context::from_json_val(
        serde_json::json!({
            "ip_address": {
                "__extn": {
                    "fn": "ip",
                    "arg": "192.168.1.50"
                }
            }
        })
    )?;
    
    // ...llamar a la evaluación con este contexto...
    ```
* Esto permite escribir políticas de red potentes:
    ```cedar
    // Permitir acceso solo desde la red interna de la oficina
    permit(principal, action, resource)
    when { 
        context.ip_address.in_range("10.0.0.0/8")
    };
    ```